name: ProjectRock - NSXOnDemand
Description: NSX OnDemand App Request
version: 1.0
formatVersion: 1
inputs:
  CIDR:
    type: string
    title: CIDR
    default: 10.10.10.0/24
  SGPort:
    type: string
    title: Security Group Port
    default: 80
  tag:
    type: string
    default: vRA-NSX-OnDemand
resources:
  HTTP:
    type: Cloud.SecurityGroup
    properties:
      rules:
        - name: http
          direction: inbound
          protocol: TCP
          ports: '${input.SGPort}'
          source: ANY
      constraints: null
      securityGroupType: new
  NSXLB:
    type: Cloud.NSX.LoadBalancer
    properties:
      type: SMALL
      loggingLevel: INFO
      routes:
        - port: '${input.SGPort}'
          protocol: HTTP
          instancePort: '${input.SGPort}'
          instanceProtocol: http
          healthCheckConfiguration:
            port: '${input.SGPort}'
            urlPath: /index.php
            protocol: HTTP
            timeoutSeconds: 4
            intervalSeconds: 5
            healthyThreshold: 2
            unhealthyThreshold: 5
          algorithm: WEIGHTED_ROUND_ROBIN
      network: '${resource["NSX-OnDemand"].id}'
      instances: '${resource.WebServers.id}'
  WebServers:
    type: Cloud.vSphere.Machine
    properties:
      count: 2
      image: ubuntu1604
      cpuCount: 1
      totalMemoryMB: 2024
      networks:
        - network: '${resource["NSX-OnDemand"].id}'
          securityGroups:
            - '${resource.HTTP.id}'
        - network: '${resource.OnDemandNSX}'
          assignPublicIpAddress: false
          assignment: static
          securityGroups:
            - '${resource.HTTP.id}'
      Infoblox.IPAM.createFixedAddress: true
      cloudConfig:
        repo_update: true
        repo_upgrade: all
        package_update: true
        package_upgrade: all
        packages:
          - apache2
          - libapache2-mod-php7.4
          - git-core
        users:
          - name: projectrock
            ssh-authorized-keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCmKkDl1xyE8FJjxDkq61V3Brdh4dtEgWnyLYuy3HxyguFz7wj7R4fheNlK4p6vYTWQk4AqlY3Fw2kzcZl2iuTmUMtFhllD236o7/aaVNw5HJKHp0B9A6LBpYDxSwPuWdotQPVoH7Vp/Ylimo1iVQOIh8t3tBClD/GatFIyw/OyrSpw6ncyw3RYkfC2ITlaCzFKGXv1weZNFK/rtyFcECvK1l4R0qLsR5CvQ/x9hFocRocMeqZ9fNV/+0Qws6f9IXKxYvBuDgMG41RFlsOsmzPNh3OQHy7VhIdeDl18aynUCopZIvM2siUAevlTrb01VOhME8Yr2CecGUI5o8aEw4R7
            sudo:
              - 'ALL=(ALL) NOPASSWD:ALL'
            groups: sudo
            shell: /bin/bash
        runcmd:
          - 'add-apt-repository ppa:ondrej/php -y'
          - apt-get update
          - a2dismod php7.0
          - a2dismod mpm_event
          - a2enmod mpm_prefork
          - a2enmod php7.4
          - cd /var/www/html
          - rm index.html
          - 'git clone https://github.com/sndrmn/ProjectRock.git .'
          - systemctl restart apache2
  NSX-OnDemand:
    type: Cloud.NSX.Network
    properties:
      networkType: routed
      name: '${input.CIDR}'
      tags:
        - key: name
          value: '${input.tag}'
      networkCidr: '${input.CIDR}'
