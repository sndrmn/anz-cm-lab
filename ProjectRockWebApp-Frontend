name: TheRock WebApp Frontend
version: 1.0
formatVersion: 1
inputs:
  WebCompute:
    type: string
    oneOf:
      - title: Tiny
        const: tiny
      - title: Small
        const: small
      - title: Medium
        const: medium
      - title: Large
        const: large
    default: tiny
  SSHPublicKey:
    type: string
    default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCmKkDl1xyE8FJjxDkq61V3Brdh4dtEgWnyLYuy3HxyguFz7wj7R4fheNlK4p6vYTWQk4AqlY3Fw2kzcZl2iuTmUMtFhllD236o7/aaVNw5HJKHp0B9A6LBpYDxSwPuWdotQPVoH7Vp/Ylimo1iVQOIh8t3tBClD/GatFIyw/OyrSpw6ncyw3RYkfC2ITlaCzFKGXv1weZNFK/rtyFcECvK1l4R0qLsR5CvQ/x9hFocRocMeqZ9fNV/+0Qws6f9IXKxYvBuDgMG41RFlsOsmzPNh3OQHy7VhIdeDl18aynUCopZIvM2siUAevlTrb01VOhME8Yr2CecGUI5o8aEw4R7
resources:
  web_sg:
    type: Cloud.SecurityGroup
    metadata:
      layoutPosition:
        - 0
        - 1
    properties:
      securityGroupType: existing
      constraints:
        - tag: 'sg:web_traffic'
  LoadBalancer:
    type: Cloud.LoadBalancer
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      routes:
        - port: '80'
          protocol: http
          instancePort: '80'
          instanceProtocol: http
          healthCheckConfiguration:
            port: '80'
            urlPath: /index.php
            protocol: http
            timeoutSeconds: 4
            intervalSeconds: 5
            healthyThreshold: 2
            unhealthyThreshold: 5
      constraints:
        - tag: 'region:sydney'
      network: '${resource.Pub_Net.id}'
      instances: '${resource.Web_Servers[*].id}'
      internetFacing: true
      name: LoadBalancer-projectrocktest
  Web_Servers:
    type: Cloud.Machine
    dependsOn:
      - web_sg
    metadata:
      layoutPosition:
        - 1
        - 1
    properties:
      image: ubuntu1604
      flavor: '${input.WebCompute}'
      constraints:
        - tag: 'region:sydney'
      networks:
        - network: '${resource.Web_Priv_Net.id}'
          assignPublicIpAddress: true
          securityGroups:
            - '${resource.web_sg.id}'
      cloudConfig:
        repo_update: true
        repo_upgrade: all
        package_update: true
        package_upgrade: all
        packages:
          - apache2
          - php
          - libapache2-mod-php7.0
          - git-core
        users:
          - name: projectrock
            ssh-authorized-keys:
              - '${input.SSHPublicKey}'
            sudo:
              - 'ALL=(ALL) NOPASSWD:ALL'
            groups: sudo
            shell: /bin/bash
        runcmd:
          - chmod 646 /etc/apache2/envvars
          - echo "export MONGOUSER=ReadUser" >> /etc/apache2/envvars
          - echo "export MONGOPASS=password" >> /etc/apache2/envvars
          - chmod 646 /etc/apache2/envvars
          - 'add-apt-repository ppa:ondrej/php -y'
          - apt-get update
          - apt-get install php7.4 -y
          - apt-get install libapache2-mod-php7.4 -y --allow-unauthenticated
          - apt-get install php7.4-mongo -y --allow-unauthenticated
          - cd /var/www/html
          - rm index.html
          - 'git clone https://github.com/sndrmn/ProjectRock.git .'
          - service apache2 restart
      count: 2
  Pub_Net:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 2
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: 'function:public'
        - tag: 'platform:aws'
  Web_Priv_Net:
    type: Cloud.Network
    metadata:
      layoutPosition:
        - 3
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: 'function:web-priv'
        - tag: 'platform:aws'
